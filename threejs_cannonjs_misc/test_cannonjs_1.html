<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/109/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r109/examples/js/controls/OrbitControls.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>
</head>
<body>
  <div id="stage"></div>

  <script>
  (function() {
      'use strict';
      
      var width  = 1000;
      var height = 500;

      // scene ステージ
      var scene = new THREE.Scene();

      // light
      var light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 100, 30);
      scene.add(light);
      // 環境光源
      var ambient = new THREE.AmbientLight(0x404040);
      scene.add(ambient);

      // camera
      var camera = new THREE.PerspectiveCamera(45, width / height, 1, 1000);
      camera.position.set(200, 100, 300);
      camera.lookAt(scene.position);

      // helper
      var gridHelper = new THREE.GridHelper(200, 50);
      scene.add(gridHelper);
      var axisHelper = new THREE.AxisHelper(1000);
      scene.add(axisHelper);
      var lightHelper = new THREE.DirectionalLightHelper(light, 20);
      scene.add(lightHelper);

      // controls
      var controls = new THREE.OrbitControls(camera);
      // controls.autoRotate = true;

      // renderer
      var renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      renderer.setClearColor(0xefefef);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.getElementById('stage').appendChild(renderer.domElement);

      // cannon.jsでワールド作成
      const world = new CANNON.World();
      world.gravity.set(0, -9.82, 0);                   // 重力を設定
      // ぶつかっている可能性のあるオブジェクト同士を見つける
      world.broadphase = new CANNON.NaiveBroadphase();
      world.solver.iterations = 8;                      // 反復計算回数
      world.solver.tolerance = 0.1;                     // 許容値

      // cannon.jsで箱作成
      const boxMass = 1;                                          // 箱の質量
      const boxShape = new CANNON.Box(new CANNON.Vec3(5, 5, 5));  // 箱の形状
      const phyBox = new CANNON.Body({mass: boxMass, shape: boxShape}); //箱作成
      phyBox.position.set(0, 100, 0);                             // 箱の位置
      phyBox.angularVelocity.set(0.1, 0.1, 0.1);                  // 角速度
      phyBox.angularDamping = 0.1;                                // 減衰率
      world.addBody(phyBox);                             // ワールドに箱追加

      // cannon.jsで床作成
      const planeMass = 0;      // 質量を0にすると衝突しても動かない
      const planeShape = new CANNON.Plane();
      const phyPlane = new CANNON.Body({mass: planeMass, shape: planeShape});
      // X軸に90度回転
      phyPlane.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0),
					   -Math.PI / 2);
      phyPlane.position.set(0, 0, 0);
      world.addBody(phyPlane);

      // three.jsで箱と床作成
      // 箱
      const boxGeometry = new THREE.BoxGeometry(10, 10, 10);
      const boxMaterial = new THREE.MeshPhongMaterial({color: 0xffffff});
      const box = new THREE.Mesh(boxGeometry, boxMaterial);
      scene.add(box);

      // 床
      const planeGeometry = new THREE.PlaneGeometry(100, 100, 1, 1);
      const planeMaterial = new THREE.MeshPhongMaterial({color: 0xdddddd});
      const plane = new THREE.Mesh(planeGeometry, planeMaterial);
      scene.add(plane);
      
      function render() {
	  requestAnimationFrame(render);
	  // ワールドの時間を進める
	  world.step(1 / 60);
	  // cannon.jsからthree.jsにオブジェクトの位置をコピー
	  box.position.copy(phyBox.position);
	  box.quaternion.copy(phyBox.quaternion);
	  plane.position.copy(phyPlane.position);
	  plane.quaternion.copy(phyPlane.quaternion);
	  
	  renderer.render(scene, camera);
      }
      
      render();
  })();
  </script>
  
</body>
</html>
